pipeline {
    agent any  // Make sure this node has Visual Studio installed

    environment {
        SOLUTION_FILE = "DotNetFrameworkProject_CE040_CE087\\Tour_Management.sln"
        BUILD_CONFIG = "Release"
        MSBUILD_PATH = "C:\\Program Files\\Microsoft Visual Studio\\18\\Enterprise\\MSBuild\\Current\\Bin\\MSBuild.exe"
        NUGET_PATH = "C:\\Program Files\\NuGet\\nuget.exe"
        PUBLISH_DIR = "C:\\inetpub\\wwwroot\\TourManagement"  // IIS deploy folder
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/kallepallinaveen/Tour_Management_Asp.Net.git'
            }
        }

        stage('Restore NuGet Packages') {
            steps {
                bat "\"%NUGET_PATH%\" restore \"%SOLUTION_FILE%\""
            }
        }

        stage('Build') {
            steps {
                bat "\"%MSBUILD_PATH%\" \"%SOLUTION_FILE%\" /p:Configuration=%BUILD_CONFIG% /t:Build /v:m"
            }
        }

        stage('Test') {
            steps {
                echo "Add unit test execution here if any"
            }
        }

        stage('Deploy') {
            steps {
                echo "Deploying to IIS..."
                // Create publish folder if it doesn't exist
                bat """
                if not exist "%PUBLISH_DIR%" mkdir "%PUBLISH_DIR%"
                xcopy /Y /E /I DotNetFrameworkProject_CE040_CE087\\Tour_Management\\bin\\%BUILD_CONFIG%\\* "%PUBLISH_DIR%\\bin\\"
                xcopy /Y /E /I DotNetFrameworkProject_CE040_CE087\\Tour_Management\\* "%PUBLISH_DIR%\\"
                """
                echo "Deployment complete"
            }
        }
    }

    post {
        success {
            echo "Build and deployment completed successfully!"
        }
        failure {
            echo "Build failed! Check Jenkins console output."
        }
    }
}
